<!DOCTYPE html>
<html>
    <head>
        <title>SINGAPORE MAP</title>
		
		<link rel="stylesheet" href="./css/dc.css">
        <!--<link rel="stylesheet" href="./css/leaflet.css">-->
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
		<link rel="stylesheet" href="./css/dc-leaflet-legend.css">
		
        <!-- <script src="./lib/d3.js"></script> -->
		<script src="http://d3js.org/d3.v3.js" charset="utf-8"></script>
        
		<script src="./lib/crossfilter.js"></script>
        <script src="./lib/dc.js"></script>
		
        <!--<script src="./lib/leaflet.js"></script>-->
		<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>

        <script src="./lib/dc-leaflet.js"></script>
		
		<script src="./lib/colorbrewer.js"></script>

        <!-- use src for testing -->
        <!-- <script src="../src/scripts/base-map-chart.js"></script>
        <script src="../src/scripts/base-leaflet-chart.js"></script>
        <script src="../src/scripts/leaflet-choropleth-chart.js"></script> -->
    </head>
    <body>
        <h1>Singapore Map Test</h1>

        <div id="sg-chart" style="width:100%; height:800px;">
            <a class="reset" href="javascript:sgChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>
            <span class="reset" style="display: none;"> | Current filter: <span class="filter"></span></span>

            <div class="clearfix"></div>
        </div>

        <div class="clearfix"></div>
<!--
        <div id="industry-chart">
            <strong>By Industries</strong> (y: number of deals, x: total amount raised in millions, radius: amount raised)
            <a class="reset" href="javascript:industryChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

            <div class="clearfix"></div>
        </div>

        <div class="clearfix"></div>

        <div id="round-chart">
            <strong>By Rounds</strong> (y: number of deals, x: total amount raised in millions, radius: amount raised)
            <a class="reset" href="javascript:roundChart.filterAll();dc.redrawAll();" style="display: none;">reset</a>

            <div class="clearfix"></div>
        </div>

        <div class="clearfix"></div> 

        <div>
            <a href="javascript:dc.filterAll(); dc.renderAll();">Reset All</a>
        </div>-->

        <script>
		
            var numberFormat = d3.format(".2f");

            var sgChart = dc.leafletChoroplethChart("#sg-chart");
            //var industryChart = dc.bubbleChart("#industry-chart");
            //var roundChart = dc.bubbleChart("#round-chart");

            d3.csv("data/sgupdated.csv", function (csv) {
                var data = crossfilter(csv);

                var planningarea = data.dimension(function (d) {
                    return d["PA"];
                });
                var population = planningarea.group().reduceSum(function (d) {
                    return d["POP"];
                });
				/*
                var industries = data.dimension(function (d) {
                    return d["Industry Group"];
                });
                var statsByIndustries = industries.group().reduce(
                        function (p, v) {
                            p.amountRaised += +v["Raised"];
                            p.deals += +v["Deals"];
                            return p;
                        },
                        function (p, v) {
                            p.amountRaised -= +v["Raised"];
                            if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                            p.deals -= +v["Deals"];
                            return p;
                        },
                        function () {
                            return {amountRaised: 0, deals: 0}
                        }
                );

                var rounds = data.dimension(function (d) {
                    return d["RoundClassDescr"];
                });
                var statsByRounds = rounds.group().reduce(
                        function (p, v) {
                            p.amountRaised += +v["Raised"];
                            p.deals += +v["Deals"];
                            return p;
                        },
                        function (p, v) {
                            p.amountRaised -= +v["Raised"];
                            if (p.amountRaised < 0.001) p.amountRaised = 0; // do some clean up
                            p.deals -= +v["Deals"];
                            return p;
                        },
                        function () {
                            return {amountRaised: 0, deals: 0}
                        }
                );*/

                d3.json("data/singapore.geojson", function (planningareaJson) {
                    sgChart
                        .dimension(planningarea)
                        .group(population)
						.center([1.35,103.8198])
                        .zoom(12)
                        .geojson(planningareaJson)
						.colors(d3.scale.quantize().range(["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
						//.colors(d3.scale.quantize().range(["#E2F2FF", "#9ED2FF", "#81C5FF",  "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
						.colorDomain([
							  d3.min(population.all(), dc.pluck('value')),
							  d3.max(population.all(), dc.pluck('value'))
						  ])					
						.colorCalculator(function (d) { return d ? sgChart.colors()(d.value) : '#ccc'; })
						/*.featureOptions(function(feature, v) {
							  return {"color": "black",                                                                                             
									  "opacity": 1,
									  "weight": 1,
									  "fillColor": 'cyan',
									  "fillOpacity": 0.3
									  }; 
								})*/
						.featureKeyAccessor(function(feature) {
                            return feature.properties.Name;
                        })
						.title(function (d) {
                            return "<font size='5' color='red'>Planning Area:" + d.key + "<br/> Population living in private housing: " + d.value +"</font>";
                        });
                        //.legend(dc.leafletLegend().position('bottomright'));

                    /*industryChart.width(990)
                            .height(200)
                            .margins({top: 10, right: 50, bottom: 30, left: 60})
                            .dimension(industries)
                            .group(statsByIndustries)
                            .colors(d3.scale.category10())
                            .keyAccessor(function (p) {
                                return p.value.amountRaised;
                            })
                            .valueAccessor(function (p) {
                                return p.value.deals;
                            })
                            .radiusValueAccessor(function (p) {
                                return p.value.amountRaised;
                            })
                            .x(d3.scale.linear().domain([0, 5000]))
                            .r(d3.scale.linear().domain([0, 4000]))
                            .minRadiusWithLabel(15)
                            .elasticY(true)
                            .yAxisPadding(100)
                            .elasticX(true)
                            .xAxisPadding(200)
                            .maxBubbleRelativeSize(0.07)
                            .renderHorizontalGridLines(true)
                            .renderVerticalGridLines(true)
                            .renderLabel(true)
                            .renderTitle(true)
                            .title(function (p) {
                                return p.key
                                        + "\n"
                                        + "Amount Raised: " + numberFormat(p.value.amountRaised) + "M\n"
                                        + "Number of Deals: " + numberFormat(p.value.deals);
                            });
                    industryChart.yAxis().tickFormat(function (s) {
                        return s + " deals";
                    });
                    industryChart.xAxis().tickFormat(function (s) {
                        return s + "M";
                    });

                    roundChart.width(990)
                            .height(200)
                            .margins({top: 10, right: 50, bottom: 30, left: 60})
                            .dimension(rounds)
                            .group(statsByRounds)
                            .colors(d3.scale.category10())
                            .keyAccessor(function (p) {
                                return p.value.amountRaised;
                            })
                            .valueAccessor(function (p) {
                                return p.value.deals;
                            })
                            .radiusValueAccessor(function (p) {
                                return p.value.amountRaised;
                            })
                            .x(d3.scale.linear().domain([0, 5000]))
                            .r(d3.scale.linear().domain([0, 9000]))
                            .minRadiusWithLabel(15)
                            .elasticY(true)
                            .yAxisPadding(150)
                            .elasticX(true)
                            .xAxisPadding(300)
                            .maxBubbleRelativeSize(0.07)
                            .renderHorizontalGridLines(true)
                            .renderVerticalGridLines(true)
                            .renderLabel(true)
                            .renderTitle(true)
                            .title(function (p) {
                                return p.key
                                        + "\n"
                                        + "Amount Raised: " + numberFormat(p.value.amountRaised) + "M\n"
                                        + "Number of Deals: " + numberFormat(p.value.deals);
                            });
                    roundChart.yAxis().tickFormat(function (s) {
                        return s + " deals";
                    });
                    roundChart.xAxis().tickFormat(function (s) {
                        return s + "M";
                    });*/
					
                    dc.renderAll();
                });
            });
        </script>
    </body>
</html>
